name: Jin10 RSS to QY WeChat

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

concurrency:
  group: jin10-rss
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      # 先检出 main 分支
      # First checkout main branch
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # 准备 bot 分支（如果存在则切换，不存在则从 main 创建）
      # Prepare bot branch (switch if exists, create from main if not)
      - name: Prepare bot branch
        run: |
          git fetch origin
          if git ls-remote --exit-code --heads origin bot/update-last >/dev/null 2>&1; then
            echo "Bot branch exists, checking out..."
            git checkout bot/update-last
            # 只同步代码文件，不同步 workflow（避免冲突）
            # Only sync code files, not workflows (to avoid conflicts)
            git checkout origin/main -- rss_to_qywx.js package.json package-lock.json README.md 2>/dev/null || true
          else
            echo "Bot branch does not exist, creating from main..."
            git checkout -b bot/update-last
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Run RSS script
        env:
          RSS_URL: ${{ secrets.RSS_URL }}
          QYWX_WEBHOOK: ${{ secrets.QYWX_WEBHOOK }}
        run: node rss_to_qywx.js

      - name: Commit and push last.json
        run: |
          git add last.json
          git diff --staged --quiet || git commit -m "chore: update last.json [skip ci]"
          git push origin bot/update-last --force-with-lease || git push -u origin bot/update-last
